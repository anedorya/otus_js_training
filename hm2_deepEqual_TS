class DeepEqualityCompare {
    constructor() {
        // Map для хранения пар объектов, которые уже были сравнены
        this.visited = new Map();
    }

    equal(a: any, b: any): boolean {
        // 1. Сравнение примитивов и null/undefined
        if (a === b) return true;
        if (a === null || b === null || typeof a !== 'object' || typeof b !== 'object') {
            // Разные типы, null и примитивы, которые не ===
            return false;
        }

        // 2. Обработка циклических ссылок
        // Проверяем, были ли эти объекты уже сравнены в текущем контексте
        const visitedB = this.visited.get(a);
        if (visitedB && visitedB.has(b)) {
            return true; // Циклическая ссылка, которая уже обрабатывалась, считаем равными
        }

        // Добавляем текущую пару объектов в отслеживание
        if (!visitedB) {
            this.visited.set(a, new Set([b]));
        } else {
            visitedB.add(b);
        }

        // 3. Сравнение типов объектов (массив/объект/дата и т.д.)
        const typeA = Object.prototype.toString.call(a);
        const typeB = Object.prototype.toString.call(b);

        if (typeA !== typeB) {
            return false;
        }

        // Специальная обработка для дат (если нужно)
        if (typeA === '[object Date]') {
            return a.getTime() === b.getTime();
        }

        // 4. Сравнение массивов
        if (Array.isArray(a)) {
            if (a.length !== b.length) return false;
            for (let i = 0; i < a.length; i++) {
                if (!this.equal(a[i], b[i])) return false;
            }
            return true;
        }

        // 5. Сравнение простых объектов
        const keysA = Object.keys(a);
        const keysB = Object.keys(b);

        if (keysA.length !== keysB.length) return false;

        for (const key of keysA) {
            if (!keysB.includes(key) || !this.equal(a[key], b[key])) {
                return false;
            }
        }

        return true;
    }
}

function deepEqual(a: any, b: any): boolean {
    const comparer = new DeepEqualityCompare();
    return comparer.equal(a, b);
}


